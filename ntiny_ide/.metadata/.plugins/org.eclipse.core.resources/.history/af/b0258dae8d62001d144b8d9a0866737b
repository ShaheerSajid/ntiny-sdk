#include "init.h"
#include "gpio.h"
#include "uart.h"
#include "uart_def.h"
#include "csr.h"
#include "timer.h"
#include <stdint.h>

int dataPin = 1;
int clockPin = 3;
int latchPin = 5;
uint16_t i = 0;

void ISR_EXT (void)
{
	volatile uint32_t	*m_uart	= 	(volatile uint32_t *)UART_BASE_ADDR;
    int x = 0;
	char *data = "External Interrupt\n";
	while (data[x] != 0)
		{
			 m_uart[U_TX/4] = data[x];
			while (m_uart[U_STATUS/4] & (1 << U_STATUS_TXFULL_SHIFT)){

			}
			x++;
		}
}

void ISR_TIMER (void)
{
	volatile uint32_t	*m_uart	= 	(volatile uint32_t *)UART_BASE_ADDR;
    int x = 0;
	char *data = "Timer Interrupt\n";
	while (data[x] != 0)
		{
			//*sim_uart = data[x];
			 m_uart[U_TX/4] = data[x];
			while (m_uart[U_STATUS/4] & (1 << U_STATUS_TXFULL_SHIFT)){

			}
			x++;
		}
}


int main(void) {
	int_disable();
	uart_init(115200);

	gpio_mode(dataPin, 1);
	gpio_mode(clockPin, 1);
	gpio_mode(latchPin, 1);

	gpio_mode(0,0);
	gpio_set_interrupt();
	csr_write(mie , (1<<19) | (1 << 7));//enable external, timer

	timer_set_prescaler(1); // set value by which you want to divide the clock frequency
	timer_set_compare(50000);
	timer_set_count(0);
	timer_start();

	int_enable();

	while (1) {

		gpio_write_pin(latchPin, 0);

		for (int j = 0; j < 16; j++) {
			gpio_write_pin(clockPin, 0);
			gpio_write_pin(dataPin, (i >> j) & 0x01);
			gpio_write_pin(clockPin, 1);
			gpio_write_pin(dataPin, 0);
		}
		gpio_write_pin(clockPin, 0);
		gpio_write_pin(latchPin, 1);
		//delay_ms(100);
		uart_puts("Hello\n");
		i++;

	}
}
