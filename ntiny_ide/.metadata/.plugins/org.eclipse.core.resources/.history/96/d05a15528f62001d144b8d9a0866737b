#include "init.h"
#include "gpio.h"
#include "uart.h"
#include "uart_def.h"
#include "csr.h"
#include "timer.h"
#include "ee_printf.h"
#include <stdint.h>

int dataPin = 1;
int clockPin = 3;
int latchPin = 5;
uint16_t i = 0;
uint16_t i_p = 0;


void ISR_EXT (void)
{
	i++;
	while(gpio_read_pin(0));
}


int main(void) {
	int_disable();
	uart_init(115200);

	gpio_mode(dataPin, 1);
	gpio_mode(clockPin, 1);
	gpio_mode(latchPin, 1);

	gpio_mode(0,0);
	gpio_set_interrupt();
	csr_write(mie , (1<<19));//enable external

	int_enable();

	while (1) {

		gpio_write_pin(latchPin, 0);

		for (int j = 0; j < 16; j++) {
			gpio_write_pin(clockPin, 0);
			gpio_write_pin(dataPin, (i >> j) & 0x01);
			gpio_write_pin(clockPin, 1);
			gpio_write_pin(dataPin, 0);
		}
		gpio_write_pin(clockPin, 0);
		gpio_write_pin(latchPin, 1);
		//delay_ms(100);
		if(i != i_p)
		{
			ee_printf("Counter: %d\n", i);
			i_p = i;
		}

	}
}
